<<<<<<< HEAD
name: ClickUp to Telegram

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check ClickUp Comments
=======
name: ClickUp to Telegram Notifications

on:
  schedule:
    # Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    - cron: '*/5 * * * *'
  workflow_dispatch: # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  check-comments:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check ClickUp and Send to Telegram
>>>>>>> e646a5e (GitHub Actions only - check every 5 minutes)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_TEAM_ID: ${{ secrets.CLICKUP_TEAM_ID }}
        run: |
<<<<<<< HEAD
          python3 << 'EOF'
          import json, os, urllib.request, urllib.parse
          from datetime import datetime

          def jalali(gy,gm,gd):
              g=[0,31,59,90,120,151,181,212,243,273,304,334]
              jy=979 if gy>1600 else 0
              gy-=1600 if gy>1600 else 621
              gy2=gy+1 if gm>2 else gy
              d=(365*gy)+(gy2+3)//4-(gy2+99)//100+(gy2+399)//400-80+gd+g[gm-1]
              jy+=33*(d//12053);d%=12053
              jy+=4*(d//1461);d%=1461
              if d>365:jy+=(d-1)//365;d=(d-1)%365
              jm,jd=(1+d//31,1+d%31) if d<186 else (7+(d-186)//30,1+(d-186)%30)
              return jy,jm,jd

          def fmt(ts):
              try:
                  ts=int(ts)
                  if ts>1e10:ts/=1000
                  dt=datetime.fromtimestamp(ts)
                  jy,jm,jd=jalali(dt.year,dt.month,dt.day)
                  m=["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±","Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"]
                  return f"{jd} {m[jm-1]} {jy} - Ø³Ø§Ø¹Øª {dt.strftime('%H:%M')}"
              except:return "Ù†Ø§Ù…Ø´Ø®Øµ"

          def send(txt):
              t,c=os.environ.get('TELEGRAM_BOT_TOKEN'),os.environ.get('TELEGRAM_CHAT_ID')
              if not t:return
              d=urllib.parse.urlencode({'chat_id':c,'text':txt,'parse_mode':'Markdown'}).encode()
              urllib.request.urlopen(f"https://api.telegram.org/bot{t}/sendMessage",d,timeout=10)

          def api(url):
              r=urllib.request.Request(url,headers={'Authorization':os.environ.get('CLICKUP_API_TOKEN')})
              return json.loads(urllib.request.urlopen(r,timeout=10).read())

          team=os.environ.get('CLICKUP_TEAM_ID')
          ago=int(datetime.now().timestamp()*1000)-300000
          tasks=api(f"https://api.clickup.com/api/v2/team/{team}/task?limit=15").get('tasks',[])
          n=0
          for t in tasks:
              for c in api(f"https://api.clickup.com/api/v2/task/{t['id']}/comment").get('comments',[])[:3]:
                  if int(c.get('date',0))>ago:
                      u=c.get('user',{})
                      send(f"ğŸ“‹ **Ø¯Ø± ØªØ³Ú© Â«{t['name']}Â»**

ğŸ‘¤ **{u.get('username') or u.get('email','?')}** Ù†ÙˆØ´ØªÙ‡:

ğŸ’¬ {c.get('comment_text','')}

ğŸ• {fmt(c.get('date'))}")
                      n+=1
          print(f"âœ… {n} Ú©Ø§Ù…Ù†Øª Ø¬Ø¯ÛŒØ¯")
          EOF
=======
          #!/bin/bash
          
          # ØªØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
          get_jalali_date() {
            python3 << 'PYTHON'
          from datetime import datetime
          def gregorian_to_jalali(gy, gm, gd):
              g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334]
              if gy > 1600:
                  jy = 979
                  gy -= 1600
              else:
                  jy = 0
                  gy -= 621
              gy2 = gy + 1 if gm > 2 else gy
              days = (365 * gy) + (gy2 + 3) // 4 - (gy2 + 99) // 100 + (gy2 + 399) // 400 - 80 + gd + g_d_m[gm - 1]
              jy += 33 * (days // 12053)
              days %= 12053
              jy += 4 * (days // 1461)
              days %= 1461
              if days > 365:
                  jy += (days - 1) // 365
                  days = (days - 1) % 365
              if days < 186:
                  jm = 1 + days // 31
                  jd = 1 + days % 31
              else:
                  jm = 7 + (days - 186) // 30
                  jd = 1 + (days - 186) % 30
              return jy, jm, jd
          now = datetime.now()
          jy, jm, jd = gregorian_to_jalali(now.year, now.month, now.day)
          months = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±", "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"]
          print(f"{jd} {months[jm-1]} {jy} - Ø³Ø§Ø¹Øª {now.strftime('%H:%M')}")
          PYTHON
          }
          
          # Ø¯Ø±ÛŒØ§ÙØª timestamp 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´ (Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡)
          FIVE_MIN_AGO=$(($(date +%s) * 1000 - 300000))
          
          echo "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯..."
          
          # Ø¯Ø±ÛŒØ§ÙØª ØªØ³Ú©â€ŒÙ‡Ø§
          TASKS=$(curl -s "https://api.clickup.com/api/v2/team/${CLICKUP_TEAM_ID}/task?limit=20" \
            -H "Authorization: ${CLICKUP_API_TOKEN}")
          
          # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§ Python
          python3 << PYTHON
          import json
          import os
          import urllib.request
          import urllib.parse
          from datetime import datetime
          
          def gregorian_to_jalali(gy, gm, gd):
              g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334]
              if gy > 1600:
                  jy = 979
                  gy -= 1600
              else:
                  jy = 0
                  gy -= 621
              gy2 = gy + 1 if gm > 2 else gy
              days = (365 * gy) + (gy2 + 3) // 4 - (gy2 + 99) // 100 + (gy2 + 399) // 400 - 80 + gd + g_d_m[gm - 1]
              jy += 33 * (days // 12053)
              days %= 12053
              jy += 4 * (days // 1461)
              days %= 1461
              if days > 365:
                  jy += (days - 1) // 365
                  days = (days - 1) % 365
              if days < 186:
                  jm = 1 + days // 31
                  jd = 1 + days % 31
              else:
                  jm = 7 + (days - 186) // 30
                  jd = 1 + (days - 186) % 30
              return jy, jm, jd
          
          def format_date(ts):
              try:
                  ts = int(ts)
                  if ts > 10000000000:
                      ts = ts / 1000
                  dt = datetime.fromtimestamp(ts)
                  jy, jm, jd = gregorian_to_jalali(dt.year, dt.month, dt.day)
                  months = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±", "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"]
                  return f"{jd} {months[jm-1]} {jy} - Ø³Ø§Ø¹Øª {dt.strftime('%H:%M')}"
              except:
                  return "Ù†Ø§Ù…Ø´Ø®Øµ"
          
          def send_telegram(text):
              token = os.environ.get('TELEGRAM_BOT_TOKEN')
              chat_id = os.environ.get('TELEGRAM_CHAT_ID')
              if not token or not chat_id:
                  return
              url = f"https://api.telegram.org/bot{token}/sendMessage"
              data = urllib.parse.urlencode({
                  'chat_id': chat_id,
                  'text': text,
                  'parse_mode': 'Markdown'
              }).encode()
              try:
                  req = urllib.request.Request(url, data=data)
                  urllib.request.urlopen(req, timeout=10)
                  print("âœ… Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")
              except Exception as e:
                  print(f"âŒ Ø®Ø·Ø§: {e}")
          
          def get_comments(task_id):
              token = os.environ.get('CLICKUP_API_TOKEN')
              url = f"https://api.clickup.com/api/v2/task/{task_id}/comment"
              req = urllib.request.Request(url, headers={'Authorization': token})
              try:
                  with urllib.request.urlopen(req, timeout=10) as response:
                      return json.loads(response.read()).get('comments', [])
              except:
                  return []
          
          # Load tasks
          tasks_json = '''$TASKS'''
          try:
              data = json.loads(tasks_json)
              tasks = data.get('tasks', [])
          except:
              tasks = []
          
          five_min_ago = $FIVE_MIN_AGO
          new_comments = 0
          
          for task in tasks[:15]:
              task_id = task.get('id')
              task_name = task.get('name', 'Ù†Ø§Ù…Ø´Ø®Øµ')
              
              comments = get_comments(task_id)
              
              for comment in comments[:3]:
                  comment_date = int(comment.get('date', 0))
                  
                  # ÙÙ‚Ø· Ú©Ø§Ù…Ù†Øªâ€ŒÙ‡Ø§ÛŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø®ÛŒØ±
                  if comment_date > five_min_ago:
                      user = comment.get('user', {})
                      username = user.get('username') or user.get('email', 'Ù†Ø§Ù…Ø´Ø®Øµ')
                      text = comment.get('comment_text', '')
                      
                      if text:
                          message = f"""ğŸ“‹ **Ø¯Ø± ØªØ³Ú© Â«{task_name}Â»**

          ğŸ‘¤ **{username}** Ù†ÙˆØ´ØªÙ‡:

          ğŸ’¬ {text}

          ğŸ• {format_date(comment_date)}"""
                          
                          send_telegram(message)
                          new_comments += 1
          
          print(f"ğŸ“Š {new_comments} Ú©Ø§Ù…Ù†Øª Ø¬Ø¯ÛŒØ¯ ÛŒØ§ÙØª Ø´Ø¯")
          PYTHON

>>>>>>> e646a5e (GitHub Actions only - check every 5 minutes)
